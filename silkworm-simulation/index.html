<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>蚕育成シミュレーション</title>
  <style>
    body {
      font-family: 'Hiragino Maru Gothic Pro', 'ヒラギノ丸ゴ Pro W4', sans-serif;
      text-align: center;
      background-color: #fefae0;
    }
    #silkworm {
      height: 200px;
      margin: 20px;
      transition: transform 0.3s;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #evolutionSmoke {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      object-fit: cover;
      z-index: 10;
    }
    #nameInputDiv {
      margin-top: 20px;
    }
    #message {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>蚕育成シミュレーション</h1>
  <div id="nameInputDiv">
    <label for="nameInput">かいこの名前：</label>
    <input type="text" id="nameInput" placeholder="かいこちゃん">
    <button onclick="setName()">決定</button>
  </div>

  <h2 id="kaiName">あなたのかいこちゃん</h2>

  <img id="silkworm" src="./images/larva.png" alt="silkworm">

  <div>
    <button onclick="stroke(this)">なでる</button>
    <button onclick="feed(this)">餌をあげる</button>
  </div>

  <video id="evolutionSmoke" muted>
    <source src="./videos/smoke.webm" type="video/webm">
    <source src="./videos/smoke.mp4" type="video/mp4">
  </video>

  <div id="message"></div>

  <audio id="sound" src="./sounds/sound.mp3"></audio>

  <script>
    let points = 0;
    let currentStage = "larva";
    let kaiName = "かいこちゃん";
    let isEvolving = false;

    function setName() {
      const input = document.getElementById("nameInput").value.trim();
      if (input) {
        kaiName = input;
        document.getElementById("kaiName").innerText = `${kaiName}`;
      }
    }

    function stroke(button) {
      if (isEvolving) return;
      interact("stroke", button);
    }

    function feed(button) {
      if (isEvolving) return;
      interact("feed", button);
    }

    function interact(action, button) {
      button.disabled = true;
      document.getElementById("sound").play();

      let happyImg = `./images/${currentStage}_happy.png`;
      let normalImg = `./images/${currentStage}.png`;

      const silkworm = document.getElementById("silkworm");
      silkworm.src = happyImg;
      setTimeout(() => {
        silkworm.src = normalImg;
        button.disabled = false;
      }, 1000);

      addPoint();
    }

    function addPoint() {
      if (points >= 15) return;
      points++;
      if (points === 5) evolve("pupa");
      if (points === 10) evolve("moth");
      if (points === 15) document.getElementById("message").innerText = "\u6700\u5927\u307e\u3067\u6210\u9577\u3057\u307e\u3057\u305f\uff01";
    }

    function evolve(nextStage) {
      isEvolving = true;
      document.getElementById("message").innerText = `おや？${kaiName}のようすが……`;

      const video = document.getElementById("evolutionSmoke");
      video.style.display = "block";
      video.play();

      setTimeout(() => {
        currentStage = nextStage;
        document.getElementById("silkworm").src = `./images/${currentStage}.png`;
        video.style.display = "none";
        isEvolving = false;
        document.getElementById("message").innerText = "";
      }, 3000);
    }
  </script>
</body>
</html>
